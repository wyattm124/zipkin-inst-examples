!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;e.length>n;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function r(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}var c={get type(){return"None"},get present(){return!1},map:function(){return this},ifPresent:function(){},flatMap:function(){return this},getOrElse:function(t){return t instanceof Function?t():t},equals:function(t){return t===this},toString:function(){return"None"}},u=function(){function t(n){e(this,t),this.value=n}return r(t,[{key:"map",value:function(e){return new t(e(this.value))}},{key:"ifPresent",value:function(t){t(this.value)}},{key:"flatMap",value:function(t){return t(this.value)}},{key:"getOrElse",value:function(){return this.value}},{key:"equals",value:function(e){return e instanceof t&&e.value===this.value}},{key:"toString",value:function(){return"Some(".concat(this.value,")")}},{key:"type",get:function(){return"Some"}},{key:"present",get:function(){return!0}}]),t}();function h(t){return t instanceof u||c.equals(t)}var p,l={Some:u,None:c,isOptional:h,verifyIsOptional:function(t){if(null==t)throw Error("Error: data is not Optional - it's null");if(!h(t))throw Error("Error: data (".concat(t,") is not an Option!"));if(h(t.value))throw Error("Error: data (".concat(t.value,") is wrapped in Option twice"))},verifyIsNotOptional:function(t){if(h(t))throw Error("Error: data (".concat(t,") is an Option!"))},fromNullable:function(t){return null==t?c:new u(t)}};function d(){return"/tmp"}var f={EOL:"\n",tmpdir:d,tmpDir:d,networkInterfaces:function(){},getNetworkInterfaces:function(){},release:function(){return void 0!==global.navigator?global.navigator.appVersion:""},type:function(){return"Browser"},cpus:function(){return[]},totalmem:function(){return Number.MAX_VALUE},freemem:function(){return Number.MAX_VALUE},uptime:function(){return 0},loadavg:function(){return[]},hostname:function(){return void 0!==global.location?global.location.hostname:""},endianness:function(){if(void 0===p){var t=new ArrayBuffer(2),e=new Uint8Array(t),n=new Uint16Array(t);if(e[0]=1,e[1]=2,258===n[0])p="BE";else{if(513!==n[0])throw Error("unable to figure out endianess");p="LE"}}return p}};function m(t,e){for(var n in t)for(var r=t[n].length-1;r>=0;r--){var o=t[n][r];if(!o.internal&&o.family===e&&("IPv4"===e||0===o.scopeid))return o.address}return"IPv4"===e?"127.0.0.1":"::1"}function v(t,e){var n={};for(var r in t)r===e&&(n[r]=t[r]);return n}function y(t){var e=f.networkInterfaces();return t&&(e=v(e,t)),m(e,"IPv4")}y.ipv4=y,y.ipv6=function(t){var e=f.networkInterfaces();return t&&(e=v(e,t)),m(e,"IPv6")};var g=y,I=function(){function t(n){e(this,t),this.addr=n}return r(t,[{key:"ipv4",value:function(){var t=this.toInt();if(t&&0!==t)return this.addr}},{key:"toInt",value:function(){var t=this.addr.split(".");return t[0]<<24|t[1]<<16|t[2]<<8|t[3]}},{key:"toString",value:function(){return"InetAddress(".concat(this.addr,")")}}]),t}();I.getLocalAddress=function(){return"object"===("undefined"==typeof process?"undefined":t(process))&&"function"==typeof process.on?new I(g.ipv4()):new I("127.0.0.1")};var S=I,w=function(){function t(){e(this,t)}return r(t,[{key:"toString",value:function(){return"".concat(this.annotationType,"()")}}]),t}(),b=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),k=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),E=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),O=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),N=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),A=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),C=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}(),R=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}();function _(t){this.name=t}_.prototype.toString=function(){return'LocalOperationStart("'.concat(this.name,'")')};var x=function(t){function n(){return e(this,n),s(this,a(n).apply(this,arguments))}return o(n,w),n}();function T(t){this.message=t}function j(t){this.serviceName=t}function L(t){this.name=t}function P(t){var e=t.port;this.host=t.host,this.port=e}function q(t){var e=t.host,n=t.port;this.serviceName=t.serviceName,this.host=e||void 0,this.port=n||0}function B(t){var e=t.port;this.host=t.host||S.getLocalAddress(),this.port=e||0}function M(t){var e=t.host,n=t.port;this.serviceName=t.serviceName,this.host=e,this.port=n}function U(t,e){this.key=t,this.value=e}T.prototype.toString=function(){return'Message("'.concat(this.message,'")')},j.prototype.toString=function(){return'ServiceName("'.concat(this.serviceName,'")')},L.prototype.toString=function(){return'Rpc("'.concat(this.name,'")')},P.prototype.toString=function(){return'ClientAddr(host="'.concat(this.host,'", port=').concat(this.port,")")},q.prototype.toString=function(){return'ServerAddr(serviceName="'.concat(this.serviceName,'", host="').concat(this.host,'", port=').concat(this.port,")")},B.prototype.toString=function(){return'LocalAddr(host="'.concat(""+this.host,'", port=').concat(this.port,")")},M.prototype.toString=function(){return'MessageAddr(serviceName="'.concat(this.serviceName,'", host="').concat(this.host,'", port=').concat(this.port,")")},U.prototype.toString=function(){return"BinaryAnnotation(".concat(this.key,'="').concat(this.value,'")')};var F={ClientSend:b,ClientRecv:k,ServerSend:E,ServerRecv:O,ProducerStart:N,ProducerStop:A,ConsumerStart:C,ConsumerStop:R,MessageAddr:M,Message:T,ServiceName:j,Rpc:L,ClientAddr:P,ServerAddr:q,LocalAddr:B,BinaryAnnotation:U,LocalOperationStart:_,LocalOperationStop:x};Object.keys(F).forEach(function(t){F[t].prototype.annotationType=t});var D=F,K=l.Some,H=function(){function t(n){e(this,t),this.evaluator=n}return r(t,[{key:"shouldSample",value:function(t){var e=this,n=t.sampled.getOrElse(function(){return e.evaluator(t)});return new K(n)}},{key:"toString",value:function(){return"Sampler(".concat(""+this.evaluator,")")}}]),t}();function J(t){return!1}function V(t){return!0}J.toString=function(){return"never sample"},V.toString=function(){return"always sample"};var X={Sampler:H,CountingSampler:function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return e(this,n),s(this,a(n).call(this,function(t){if(t>0){if(1>t){var e=0,n=parseInt(1/t),r=function(t){var r=0==(e%=n);return e++,r};return r.toString=function(){return"countingSampler: sampleRate=".concat(t)},r}return V}return J}(1>t?t:1)))}return o(n,H),n}(),neverSample:J,alwaysSample:V},Z=function(){function t(n){var r=n.traceId,o=n.timestamp,a=n.annotation;e(this,t),this.traceId=r,this.timestamp=o,this.annotation=a}return r(t,[{key:"toString",value:function(){return"Record(traceId=".concat(""+this.traceId,", annotation=").concat(""+this.annotation,")")}}]),t}(),$=l.Some,z=l.None,G=l.verifyIsOptional,Q=l.verifyIsNotOptional,W=function(){function t(n){e(this,t);var r=n.traceId,o=void 0===r?z:r,a=n.parentId,i=void 0===a?z:a,s=n.spanId,c=n.sampled,u=void 0===c?z:c,h=n.flags,p=void 0===h?0:h;G(o),G(i),Q(s),G(u),this._traceId=o,this._parentId=i,this._spanId=s,this._sampled=u,this._flags=p}return r(t,[{key:"isDebug",value:function(){return 1==(1&this._flags)}},{key:"toString",value:function(){return"TraceId(spanId=".concat(""+this.spanId)+", parentId=".concat(""+this.parentId)+", traceId=".concat(""+this.traceId,")")}},{key:"spanId",get:function(){return this._spanId}},{key:"parentId",get:function(){return this._parentId.getOrElse(this.spanId)}},{key:"traceId",get:function(){return this._traceId.getOrElse(this.parentId)}},{key:"sampled",get:function(){return this.isDebug()?new $(!0):this._sampled}},{key:"flags",get:function(){return this._flags}}]),t}();var Y=function(){for(var t="",e=0;16>e;e++)t+="0123456789abcdef"[Math.floor(16*Math.random())];return t},tt="undefined"!=typeof process&&process.hrtime;var et={now:tt?function(t,e){if(t&&e){var n=process.hrtime(e);return t+Math.floor(1e6*n[0]+n[1]/1e3)}return 1e3*Date.now()}:function(){return 1e3*Date.now()},hrtime:tt?function(){return process.hrtime()}:function(){}};function nt(t){var e=t.ipv4,n=t.port;this.setServiceName(t.serviceName),this.setIpv4(e),this.setPort(n)}function rt(t,e){this.timestamp=t,this.value=""+e}function ot(t){var e=this;this.traceId=t.traceId,t._parentId.ifPresent(function(t){e.parentId=t}),this.id=t.spanId,this.name=void 0,this.kind=void 0,this.timestamp=void 0,this.duration=void 0,this.localEndpoint=void 0,this.remoteEndpoint=void 0,this.annotations=[],this.tags={},this.debug=t.isDebug(),this.shared=!1}nt.prototype.setServiceName=function(t){this.serviceName=t?t.toLocaleLowerCase():void 0},nt.prototype.setIpv4=function(t){this.ipv4=t},nt.prototype.setPort=function(t){this.port=t||void 0},nt.prototype.isEmpty=function(){return void 0===this.serviceName&&void 0===this.ipv4&&void 0===this.port},rt.prototype.toString=function(){return'Annotation(value="'.concat(this.value,'")')},ot.prototype.setName=function(t){this.name=t?t.toLocaleLowerCase():void 0},ot.prototype.setKind=function(t){this.kind=t},ot.prototype.setTimestamp=function(t){this.timestamp=t},ot.prototype.setDuration=function(t){void 0!==t&&(this.duration=Math.max(t,1))},ot.prototype.setLocalEndpoint=function(t){this.localEndpoint=t&&!t.isEmpty()?t:void 0},ot.prototype.setRemoteEndpoint=function(t){this.remoteEndpoint=t&&!t.isEmpty()?t:void 0},ot.prototype.addAnnotation=function(t,e){this.annotations.push(new rt(t,e))},ot.prototype.putTag=function(t,e){this.tags[t]=""+e},ot.prototype.setDebug=function(t){this.debug=t},ot.prototype.setShared=function(t){this.shared=t},ot.prototype.toString=function(){var t=this.annotations.map(function(t){return""+t}).join(", ");return"Span(id=".concat(this.traceId,", annotations=[").concat(t,"])")};var at={Endpoint:nt,Span:ot},it=function(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then};var st=l.None,ct=l.Some,ut=l.fromNullable,ht=X.Sampler,pt=X.alwaysSample,lt=et.now,dt=et.hrtime,ft=at.Endpoint;function mt(t){throw Error("Tracer: Missing required argument ".concat(t,"."))}var vt=function(){function t(n){var r=n.ctxImpl,o=void 0===r?mt("ctxImpl"):r,a=n.recorder,i=void 0===a?mt("recorder"):a,s=n.sampler,c=void 0===s?new ht(pt):s,u=n.traceId128Bit,h=void 0!==u&&u,p=n.supportsJoin,l=void 0===p||p,d=n.localServiceName,f=n.localEndpoint,m=n.log,v=void 0===m?console:m,y=n.defaultTags;e(this,t),this.log=v,this.recorder=i,this.sampler=c,this.traceId128Bit=h,this.supportsJoin=l,this._localEndpoint=f||new ft({serviceName:d||"unknown"}),this._ctxImpl=o,this._defaultTraceId=this.createRootId(),this._startTimestamp=lt(),this._startTick=dt(),y&&this.setTags(y)}return r(t,[{key:"scoped",value:function(t){return this._ctxImpl.scoped(t)}},{key:"letId",value:function(t,e){return this._ctxImpl.letContext(t,e)}},{key:"createRootId",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:st,e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=Y(),r=this.traceId128Bit?new ct(Y()+n):st,o=new W({traceId:r,parentId:st,spanId:n,sampled:t,flags:e?1:0});return t===st&&(o._sampled=this.sampler.shouldSample(o)),o}},{key:"createChildId",value:function(){var t=ut(this._ctxImpl.getContext()),e=new W({traceId:t.map(function(t){return t.traceId}),parentId:t.map(function(t){return t.spanId}),spanId:Y(),sampled:t.flatMap(function(t){return t.sampled}),flags:t.map(function(t){return t.flags}).getOrElse(0)});return!1===e.sampled.present&&(e._sampled=this.sampler.shouldSample(e)),e}},{key:"local",value:function(t,e){var n=this;if("function"!=typeof e)throw Error("you must pass a function");return this.scoped(function(){var r,o=n.createChildId();n.setId(o),n.recordServiceName(n._localEndpoint.serviceName),n.recordAnnotation(new D.LocalOperationStart(t));try{r=e()}catch(t){throw n.recordBinary("error",t.message?t.message:""+t),n.recordAnnotation(new D.LocalOperationStop),t}if(!it(r))return n.recordAnnotation(new D.LocalOperationStop),r;if(!o.sampled.getOrElse(!1))return r;var a=function(t){return n.recorder.record(new Z({traceId:o,timestamp:lt(n._startTimestamp,n._startTick),annotation:t}))};return r.then(function(t){return a(new D.LocalOperationStop),t}).catch(function(t){throw a(new D.BinaryAnnotation("error",t.message?t.message:""+t)),a(new D.LocalOperationStop),t})})}},{key:"setId",value:function(t){this._ctxImpl.setContext(t)}},{key:"recordAnnotation",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lt(this._startTimestamp,this._startTick);this.id.sampled.ifPresent(function(r){r&&e.recorder.record(new Z({traceId:e.id,timestamp:n,annotation:t}))})}},{key:"recordMessage",value:function(t){this.recordAnnotation(new D.Message(t))}},{key:"recordServiceName",value:function(t){this.recordAnnotation(new D.ServiceName(t))}},{key:"recordRpc",value:function(t){this.recordAnnotation(new D.Rpc(t))}},{key:"recordClientAddr",value:function(t){this.recordAnnotation(new D.ClientAddr(t))}},{key:"recordServerAddr",value:function(t){this.recordAnnotation(new D.ServerAddr(t))}},{key:"recordLocalAddr",value:function(t){this.recordAnnotation(new D.LocalAddr(t))}},{key:"recordBinary",value:function(t,e){this.recordAnnotation(new D.BinaryAnnotation(t,e))}},{key:"writeIdToConsole",value:function(t){this.log.info("".concat(t,": ").concat(""+this.id))}},{key:"setTags",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var e in t)t.hasOwnProperty(e)&&this.recordBinary(e,t[e])}},{key:"id",get:function(){return this._ctxImpl.getContext()||this._defaultTraceId}},{key:"localEndpoint",get:function(){return this._localEndpoint}}]),t}(),yt=function(){function t(){e(this,t),this.currentCtx=null}return r(t,[{key:"setContext",value:function(t){this.currentCtx=t}},{key:"getContext",value:function(){return this.currentCtx}},{key:"scoped",value:function(t){var e=this.currentCtx,n=t();return this.currentCtx=e,n}},{key:"letContext",value:function(t,e){var n=this;return this.scoped(function(){return n.setContext(t),e()})}}]),t}(),gt={TraceId:"X-B3-TraceId",SpanId:"X-B3-SpanId",ParentSpanId:"X-B3-ParentSpanId",Sampled:"X-B3-Sampled",Flags:"X-B3-Flags"},It=et.now,St=et.hrtime,wt=at.Span,bt=at.Endpoint;function kt(t){this.traceId=t,this.startTimestamp=It(),this.startTick=St(),this.delegate=new wt(t),this.localEndpoint=new bt({})}kt.prototype.finish=function(){this.endTimestamp||(this.endTimestamp=It(this.startTimestamp,this.startTick))};var Et=function(){function t(n){var r=this,o=n.logger,a=n.timeout,i=void 0===a?6e7:a;e(this,t),this.logger=o,this.timeout=i,this.partialSpans=new Map;var s=setInterval(function(){r.partialSpans.forEach(function(t,e){r._timedOut(t)&&r._writeSpan(e)})},1e3);s.unref&&s.unref()}return r(t,[{key:"_writeSpan",value:function(t){var e=this.partialSpans.get(t);if(void 0!==e){this.partialSpans.delete(t);var n=e.delegate;n.setLocalEndpoint(e.localEndpoint),e.endTimestamp&&(n.setTimestamp(e.startTimestamp),n.setDuration(e.endTimestamp-e.startTimestamp)),this.logger.logSpan(n)}}},{key:"_updateSpanMap",value:function(t,e){var n;e(n=this.partialSpans.has(t)?this.partialSpans.get(t):new kt(t)),n.endTimestamp?this._writeSpan(t):this.partialSpans.set(t,n)}},{key:"_timedOut",value:function(t){return t.startTimestamp+this.timeout<It()}},{key:"record",value:function(t){var e=t.traceId;this._updateSpanMap(e,function(n){switch(t.annotation.annotationType){case"ClientSend":n.delegate.setKind("CLIENT");break;case"ClientRecv":n.finish(),n.delegate.setKind("CLIENT");break;case"ServerSend":n.finish(),n.delegate.setKind("SERVER");break;case"ServerRecv":n.delegate.setShared(e.parentId!==e.spanId),n.delegate.setKind("CLIENT");break;case"ProducerStart":n.delegate.setKind("PRODUCER");break;case"ProducerStop":n.finish(),n.delegate.setKind("PRODUCER");break;case"ConsumerStart":n.delegate.setKind("CONSUMER");break;case"ConsumerStop":n.finish(),n.delegate.setKind("CONSUMER");break;case"MessageAddr":n.delegate.setRemoteEndpoint(new bt({serviceName:t.annotation.serviceName,ipv4:t.annotation.host&&t.annotation.host.ipv4(),port:t.annotation.port}));break;case"LocalOperationStart":n.delegate.setName(t.annotation.name);break;case"LocalOperationStop":n.finish();break;case"Message":n.delegate.addAnnotation(t.timestamp,t.annotation.message);break;case"Rpc":n.delegate.setName(t.annotation.name);break;case"ServiceName":n.localEndpoint.setServiceName(t.annotation.serviceName);break;case"BinaryAnnotation":n.delegate.putTag(t.annotation.key,t.annotation.value);break;case"LocalAddr":n.localEndpoint.setIpv4(t.annotation.host&&t.annotation.host.ipv4()),n.localEndpoint.setPort(t.annotation.port);break;case"ServerAddr":n.delegate.setKind("CLIENT"),n.delegate.setRemoteEndpoint(new bt({serviceName:t.annotation.serviceName,ipv4:t.annotation.host&&t.annotation.host.ipv4(),port:t.annotation.port}))}})}},{key:"toString",value:function(){return"BatchRecorder()"}}]),t}(),Ot=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:console.log;e(this,t),this.logger=n}return r(t,[{key:"record",value:function(t){var e=t.traceId;this.logger("Record at (spanId=".concat(e.spanId,", parentId=").concat(e.parentId,",")+" traceId=".concat(e.traceId,"): ").concat(""+t.annotation))}},{key:"toString",value:function(){return"consoleTracer"}}]),t}(),Nt=2147483647,At=36,Ct=1,Rt=26,_t=38,xt=700,Tt=72,jt=128,Lt="-",Pt=/[^\x20-\x7E]/,qt=/[\x2E\u3002\uFF0E\uFF61]/g,Bt={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},Mt=At-Ct,Ut=Math.floor,Ft=String.fromCharCode;function Dt(t){throw new RangeError(Bt[t])}function Kt(t,e){return t+22+75*(26>t)-((0!=e)<<5)}function Ht(t,e,n){var r=0;for(t=n?Ut(t/xt):t>>1,t+=Ut(t/e);t>Mt*Rt>>1;r+=At)t=Ut(t/Mt);return Ut(r+(Mt+1)*t/(t+_t))}function Jt(t){return function(t,e){var n=t.split("@"),r="";n.length>1&&(r=n[0]+"@",t=n[1]);var o=function(t,e){for(var n=t.length,r=[];n--;)r[n]=e(t[n]);return r}((t=t.replace(qt,".")).split("."),e).join(".");return r+o}(t,function(t){return Pt.test(t)?"xn--"+function(t){var e,n,r,o,a,i,s,c,u,h,p,l,d,f,m,v=[];for(l=(t=function(t){for(var e,n,r=[],o=0,a=t.length;a>o;)55296>(e=t.charCodeAt(o++))||e>56319||o>=a?r.push(e):56320==(64512&(n=t.charCodeAt(o++)))?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),o--);return r}(t)).length,e=jt,n=0,a=Tt,i=0;l>i;++i)128>(p=t[i])&&v.push(Ft(p));for(r=o=v.length,o&&v.push(Lt);l>r;){for(s=Nt,i=0;l>i;++i)(p=t[i])>=e&&s>p&&(s=p);for(s-e>Ut((Nt-n)/(d=r+1))&&Dt("overflow"),n+=(s-e)*d,e=s,i=0;l>i;++i)if(e>(p=t[i])&&++n>Nt&&Dt("overflow"),p==e){for(c=n,u=At;(h=u>a?a+Rt>u?u-a:Rt:Ct)<=c;u+=At)v.push(Ft(Kt(h+(m=c-h)%(f=At-h),0))),c=Ut(m/f);v.push(Ft(Kt(c,0))),a=Ht(n,d,r==o),n=0,++r}++n,++e}return v.join("")}(t):t})}global,global;global;function Vt(t){return null===t}function Xt(t){return"string"==typeof t}function Zt(t){return"object"==typeof t&&null!==t}function $t(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var zt=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function Gt(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}}function Qt(t,e){if(t.map)return t.map(e);for(var n=[],r=0;t.length>r;r++)n.push(e(t[r],r));return n}var Wt=Object.keys||function(t){var e=[];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.push(n);return e};function Yt(t,e,n,r){n=n||"=";var o={};if("string"!=typeof t||0===t.length)return o;var a=/\+/g;t=t.split(e=e||"&");var i=1e3;r&&"number"==typeof r.maxKeys&&(i=r.maxKeys);var s=t.length;i>0&&s>i&&(s=i);for(var c=0;s>c;++c){var u,h,p,l,d=t[c].replace(a,"%20"),f=d.indexOf(n);0>f?(u=d,h=""):(u=d.substr(0,f),h=d.substr(f+1)),p=decodeURIComponent(u),l=decodeURIComponent(h),$t(o,p)?zt(o[p])?o[p].push(l):o[p]=[o[p],l]:o[p]=l}return o}var te={parse:me,resolve:function(t,e){return me(t,!1,!0).resolve(e)},resolveObject:function(t,e){return t?me(t,!1,!0).resolveObject(e):e},format:function(t){Xt(t)&&(t=ve({},t));return ye(t)},Url:ee};function ee(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var ne=/^([a-z0-9.+-]+:)/i,re=/:[0-9]*$/,oe=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,ae=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),ie=["'"].concat(ae),se=["%","/","?",";","#"].concat(ie),ce=["/","?","#"],ue=255,he=/^[+a-z0-9A-Z_-]{0,63}$/,pe=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,le={javascript:!0,"javascript:":!0},de={javascript:!0,"javascript:":!0},fe={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function me(t,e,n){if(t&&Zt(t)&&t instanceof ee)return t;var r=new ee;return r.parse(t,e,n),r}function ve(t,e,n,r){if(!Xt(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var o=e.indexOf("?"),a=-1!==o&&o<e.indexOf("#")?"?":"#",i=e.split(a);i[0]=i[0].replace(/\\/g,"/");var s=e=i.join(a);if(s=s.trim(),!r&&1===e.split("#").length){var c=oe.exec(s);if(c)return t.path=s,t.href=s,t.pathname=c[1],c[2]?(t.search=c[2],t.query=n?Yt(t.search.substr(1)):t.search.substr(1)):n&&(t.search="",t.query={}),t}var u,h,p,l=ne.exec(s);if(l){var d=(l=l[0]).toLowerCase();t.protocol=d,s=s.substr(l.length)}if(r||l||s.match(/^\/\/[^@\/]+@[^@\/]+/)){var f="//"===s.substr(0,2);!f||l&&de[l]||(s=s.substr(2),t.slashes=!0)}if(!de[l]&&(f||l&&!fe[l])){var m,v,y=-1;for(u=0;ce.length>u;u++)-1===(h=s.indexOf(ce[u]))||-1!==y&&h>=y||(y=h);for(-1!==(v=-1===y?s.lastIndexOf("@"):s.lastIndexOf("@",y))&&(m=s.slice(0,v),s=s.slice(v+1),t.auth=decodeURIComponent(m)),y=-1,u=0;se.length>u;u++)-1===(h=s.indexOf(se[u]))||-1!==y&&h>=y||(y=h);-1===y&&(y=s.length),t.host=s.slice(0,y),s=s.slice(y),ge(t),t.hostname=t.hostname||"";var g="["===t.hostname[0]&&"]"===t.hostname[t.hostname.length-1];if(!g){var I=t.hostname.split(/\./);for(u=0,p=I.length;p>u;u++){var S=I[u];if(S&&!S.match(he)){for(var w="",b=0,k=S.length;k>b;b++)S.charCodeAt(b)>127?w+="x":w+=S[b];if(!w.match(he)){var E=I.slice(0,u),O=I.slice(u+1),N=S.match(pe);N&&(E.push(N[1]),O.unshift(N[2])),O.length&&(s="/"+O.join(".")+s),t.hostname=E.join(".");break}}}}t.hostname=t.hostname.length>ue?"":t.hostname.toLowerCase(),g||(t.hostname=Jt(t.hostname)),t.host=(t.hostname||"")+(t.port?":"+t.port:""),t.href+=t.host,g&&(t.hostname=t.hostname.substr(1,t.hostname.length-2),"/"!==s[0]&&(s="/"+s))}if(!le[d])for(u=0,p=ie.length;p>u;u++){var A=ie[u];if(-1!==s.indexOf(A)){var C=encodeURIComponent(A);C===A&&(C=escape(A)),s=s.split(A).join(C)}}var R=s.indexOf("#");-1!==R&&(t.hash=s.substr(R),s=s.slice(0,R));var _=s.indexOf("?");(-1!==_?(t.search=s.substr(_),t.query=s.substr(_+1),n&&(t.query=Yt(t.query)),s=s.slice(0,_)):n&&(t.search="",t.query={}),s&&(t.pathname=s),fe[d]&&t.hostname&&!t.pathname&&(t.pathname="/"),t.pathname||t.search)&&(t.path=(t.pathname||"")+(t.search||""));return t.href=ye(t),t}function ye(t){var e=t.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var n,r,o,a,i=t.protocol||"",s=t.pathname||"",c=t.hash||"",u=!1,h="";t.host?u=e+t.host:t.hostname&&(u=e+(-1===t.hostname.indexOf(":")?t.hostname:"["+this.hostname+"]"),t.port&&(u+=":"+t.port)),t.query&&Zt(t.query)&&Object.keys(t.query).length&&(r=r||"&",o=o||"=",null===(n=t.query)&&(n=void 0),h="object"==typeof n?Qt(Wt(n),function(t){var e=encodeURIComponent(Gt(t))+o;return zt(n[t])?Qt(n[t],function(t){return e+encodeURIComponent(Gt(t))}).join(r):e+encodeURIComponent(Gt(n[t]))}).join(r):a?encodeURIComponent(Gt(a))+o+encodeURIComponent(Gt(n)):"");var p=t.search||h&&"?"+h||"";return i&&":"!==i.substr(-1)&&(i+=":"),t.slashes||(!i||fe[i])&&!1!==u?(u="//"+(u||""),s&&"/"!==s.charAt(0)&&(s="/"+s)):u||(u=""),c&&"#"!==c.charAt(0)&&(c="#"+c),p&&"?"!==p.charAt(0)&&(p="?"+p),i+u+(s=s.replace(/[?#]/g,function(t){return encodeURIComponent(t)}))+(p=p.replace("#","%23"))+c}function ge(t){var e=t.host,n=re.exec(e);n&&(":"!==(n=n[0])&&(t.port=n.substr(1)),e=e.substr(0,e.length-n.length)),e&&(t.hostname=e)}ee.prototype.parse=function(t,e,n){return ve(this,t,e,n)},ee.prototype.format=function(){return ye(this)},ee.prototype.resolve=function(t){return this.resolveObject(me(t,!1,!0)).format()},ee.prototype.resolveObject=function(t){if(Xt(t)){var e=new ee;e.parse(t,!1,!0),t=e}for(var n,r=new ee,o=Object.keys(this),a=0;o.length>a;a++){var i=o[a];r[i]=this[i]}if(r.hash=t.hash,""===t.href)return r.href=r.format(),r;if(t.slashes&&!t.protocol){for(var s=Object.keys(t),c=0;s.length>c;c++){var u=s[c];"protocol"!==u&&(r[u]=t[u])}return fe[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(t.protocol&&t.protocol!==r.protocol){if(!fe[t.protocol]){for(var h=Object.keys(t),p=0;h.length>p;p++){var l=h[p];r[l]=t[l]}return r.href=r.format(),r}if(r.protocol=t.protocol,t.host||de[t.protocol])r.pathname=t.pathname;else{for(n=(t.pathname||"").split("/");n.length&&!(t.host=n.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==n[0]&&n.unshift(""),2>n.length&&n.unshift(""),r.pathname=n.join("/")}if(r.search=t.search,r.query=t.query,r.host=t.host||"",r.auth=t.auth,r.hostname=t.hostname||t.host,r.port=t.port,r.pathname||r.search)r.path=(r.pathname||"")+(r.search||"");return r.slashes=r.slashes||t.slashes,r.href=r.format(),r}var d,f=r.pathname&&"/"===r.pathname.charAt(0),m=t.host||t.pathname&&"/"===t.pathname.charAt(0),v=m||f||r.host&&t.pathname,y=v,g=r.pathname&&r.pathname.split("/")||[],I=r.protocol&&!fe[r.protocol];if(n=t.pathname&&t.pathname.split("/")||[],I&&(r.hostname="",r.port=null,r.host&&(""===g[0]?g[0]=r.host:g.unshift(r.host)),r.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===n[0]?n[0]=t.host:n.unshift(t.host)),t.host=null),v=v&&(""===n[0]||""===g[0])),m)r.host=t.host||""===t.host?t.host:r.host,r.hostname=t.hostname||""===t.hostname?t.hostname:r.hostname,r.search=t.search,r.query=t.query,g=n;else if(n.length)g||(g=[]),g.pop(),g=g.concat(n),r.search=t.search,r.query=t.query;else if(null!=t.search)return I&&(r.hostname=r.host=g.shift(),(d=!(!r.host||0>=r.host.indexOf("@"))&&r.host.split("@"))&&(r.auth=d.shift(),r.host=r.hostname=d.shift())),r.search=t.search,r.query=t.query,Vt(r.pathname)&&Vt(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!g.length)return r.pathname=null,r.path=r.search?"/"+r.search:null,r.href=r.format(),r;for(var S=g.slice(-1)[0],w=(r.host||t.host||g.length>1)&&("."===S||".."===S)||""===S,b=0,k=g.length;k>=0;k--)"."===(S=g[k])?g.splice(k,1):".."===S?(g.splice(k,1),b++):b&&(g.splice(k,1),b--);if(!v&&!y)for(;b--;b)g.unshift("..");!v||""===g[0]||g[0]&&"/"===g[0].charAt(0)||g.unshift(""),w&&"/"!==g.join("/").substr(-1)&&g.push("");var E=""===g[0]||g[0]&&"/"===g[0].charAt(0);return I&&(r.hostname=r.host=E?"":g.length?g.shift():"",(d=!(!r.host||0>=r.host.indexOf("@"))&&r.host.split("@"))&&(r.auth=d.shift(),r.host=r.hostname=d.shift())),(v=v||r.host&&g.length)&&!E&&g.unshift(""),g.length?r.pathname=g.join("/"):(r.pathname=null,r.path=null),Vt(r.pathname)&&Vt(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=t.auth||r.auth,r.slashes=r.slashes||t.slashes,r.href=r.format(),r},ee.prototype.parseHost=function(){return ge(this)};var Ie=function(t){var e=te.parse(t);return{host:e.hostname,path:e.pathname}},Se=l.Some,we=l.None;function be(t){return"1"===t||"true"===t}function ke(t){try{return new Se(parseInt(t))}catch(t){return we}}function Ee(t){throw Error("HttpServerInstrumentation: Missing required argument ".concat(t,"."))}var Oe=function(){function t(n){var r=n.tracer,o=void 0===r?Ee("tracer"):r,a=n.serviceName,i=void 0===a?o.localEndpoint.serviceName:a,s=n.host,c=n.port,u=void 0===c?Ee("port"):c;e(this,t),this.tracer=o,this.serviceName=i,this.host=s&&new S(s),this.port=u}return r(t,[{key:"_createIdFromHeaders",value:function(t){var e=this;if(function(t){return t(gt.TraceId)!==we&&t(gt.SpanId)!==we}(t)){var n=t(gt.SpanId).map(function(e){var n=t(gt.TraceId),r=t(gt.ParentSpanId),o=t(gt.Sampled),a=t(gt.Flags).flatMap(ke).getOrElse(0);return new W({traceId:n,parentId:r,spanId:e,sampled:o.map(be),flags:a})});return this.tracer.supportsJoin?n:n.map(function(t){return e.tracer.letId(t,function(){return e.tracer.createChildId()})})}if(t(gt.Flags)!==we||t(gt.Sampled)!==we){var r=t(gt.Sampled)===we?we:t(gt.Sampled).map(be),o=t(gt.Flags).flatMap(ke).getOrElse(0);return new Se(this.tracer.createRootId(r,1===o))}return new Se(this.tracer.createRootId())}},{key:"recordRequest",value:function(t,e,n){var r=this;this._createIdFromHeaders(n).ifPresent(function(t){return r.tracer.setId(t)});var o=this.tracer.id,a=Ie(e).path;return this.tracer.recordServiceName(this.serviceName),this.tracer.recordRpc(t.toUpperCase()),this.tracer.recordBinary("http.path",a),this.tracer.recordAnnotation(new D.ServerRecv),this.tracer.recordAnnotation(new D.LocalAddr({host:this.host,port:this.port})),o}},{key:"recordResponse",value:function(t,e,n){this.tracer.setId(t),this.tracer.recordBinary("http.status_code",""+e),n?this.tracer.recordBinary("error",""+n):(200>e||e>399)&&this.tracer.recordBinary("error",""+e),this.tracer.recordAnnotation(new D.ServerSend)}}]),t}();var Ne={addZipkinHeaders:function(t,e){var n=function(t,e){var n=t.headers||{};return n[gt.TraceId]=e.traceId,n[gt.SpanId]=e.spanId,e._parentId.ifPresent(function(t){n[gt.ParentSpanId]=t}),e.sampled.ifPresent(function(t){n[gt.Sampled]=t?"1":"0"}),e.isDebug()&&(n[gt.Flags]="1"),n}(t,e);return Object.assign({},t,{headers:n})}};var Ae=function(){function t(n){var r=n.tracer,o=void 0===r?function(t){throw Error("HttpClientInstrumentation: Missing required argument ".concat(t,"."))}("tracer"):r,a=n.serviceName,i=void 0===a?o.localEndpoint.serviceName:a,s=n.remoteServiceName;e(this,t),this.tracer=o,this.serviceName=i,this.remoteServiceName=s}return r(t,[{key:"recordRequest",value:function(t,e,n){this.tracer.setId(this.tracer.createChildId());var r=this.tracer.id,o=Ie(e).path;return this.tracer.recordServiceName(this.serviceName),this.tracer.recordRpc(n.toUpperCase()),this.tracer.recordBinary("http.path",o),this.tracer.recordAnnotation(new D.ClientSend),this.remoteServiceName&&this.tracer.recordAnnotation(new D.ServerAddr({serviceName:this.remoteServiceName})),Ne.addZipkinHeaders(t,r)}},{key:"recordResponse",value:function(t,e){this.tracer.setId(t),this.tracer.recordBinary("http.status_code",""+e),(200>e||e>399)&&this.tracer.recordBinary("error",""+e),this.tracer.recordAnnotation(new D.ClientRecv)}},{key:"recordError",value:function(t,e){this.tracer.setId(t),this.tracer.recordBinary("error",""+e),this.tracer.recordAnnotation(new D.ClientRecv)}}]),t}();function Ce(t){if(void 0!==t){var e={serviceName:t.serviceName||""};return t.ipv4&&(e.ipv4=t.ipv4),t.port&&(e.port=t.port),e}}module.exports={Tracer:vt,createNoopTracer:function(){var t=new yt;return new vt({recorder:{record:function(){}},ctxImpl:t})},randomTraceId:Y,TraceId:W,option:l,Annotation:D,InetAddress:S,HttpHeaders:gt,BatchRecorder:Et,ConsoleRecorder:Ot,ExplicitContext:yt,sampler:X,Request:Ne,Instrumentation:{HttpServer:Oe,HttpClient:Ae},model:at,jsonEncoder:{JSON_V1:{encode:function(t){return function(t){var e={traceId:t.traceId};t.parentId&&(e.parentId=t.parentId),e.id=t.id,e.name=t.name||"",t.shared||(e.timestamp=t.timestamp,e.duration=t.duration);var n,r,o,a=Ce(t.localEndpoint);switch(t.kind){case"CLIENT":n=t.timestamp?"cs":void 0,r="cr",o="sa";break;case"SERVER":n=t.timestamp?"sr":void 0,r="ss",o="ca";break;case"PRODUCER":n=t.timestamp?"ms":void 0,r="ws",o="ma";break;case"CONSUMER":t.timestamp&&t.duration?(n="wr",r="mr"):t.timestamp&&(n="mr"),o="ma"}(t.annotations.length>0||n)&&(e.annotations=t.annotations.map(function(t){return function(t,e){return{value:t.value,timestamp:t.timestamp,endpoint:e}}(t,a)})),n&&(e.annotations.push({value:n,timestamp:t.timestamp,endpoint:a}),t.duration&&e.annotations.push({value:r,timestamp:t.timestamp+t.duration,endpoint:a}));var i=Object.keys(t.tags);if((i.length>0||t.remoteEndpoint)&&(e.binaryAnnotations=i.map(function(e){return{key:e,value:t.tags[e],endpoint:a}})),t.remoteEndpoint){var s={key:o,value:!0,endpoint:Ce(t.remoteEndpoint)};e.binaryAnnotations.push(s)}return t.debug&&(e.debug=!0),JSON.stringify(e)}(t)}},JSON_V2:{encode:function(t){return function(t){var e={traceId:t.traceId};return t.parentId&&(e.parentId=t.parentId),e.id=t.id,t.name&&(e.name=t.name),t.kind&&(e.kind=t.kind),t.timestamp&&(e.timestamp=t.timestamp),t.duration&&(e.duration=t.duration),t.localEndpoint&&(e.localEndpoint=t.localEndpoint),t.remoteEndpoint&&(e.remoteEndpoint=t.remoteEndpoint),t.annotations.length>0&&(e.annotations=t.annotations),Object.keys(t.tags).length>0&&(e.tags=t.tags),t.debug&&(e.debug=!0),t.shared&&(e.shared=!0),JSON.stringify(e)}(t)}}},parseRequestUrl:Ie}});
